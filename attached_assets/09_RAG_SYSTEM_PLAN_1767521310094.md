# ðŸ” Phase 9: RAG System Plan

**DuraciÃ³n:** 1 semana  
**Prioridad:** P3 - Bajo  
**Gap:** 100% - No implementado

---

## ðŸŽ¯ Objetivo

Implementar bÃºsqueda semÃ¡ntica en Actions Library usando embeddings.

---

## ðŸ“Š Caso de Uso

- Buscar acciones relevantes basadas en contexto del mÃ³dulo
- Sugerir playbooks similares a situaciones pasadas
- Encontrar insights relacionados en histÃ³rico

---

## ðŸ—ï¸ Arquitectura

```
backend/apps/rag/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ services.py         # EmbeddingsService, ActionSearchService
â”œâ”€â”€ models.py           # EmbeddingStore
â”œâ”€â”€ indexers.py         # PlaybookIndexer, ActionIndexer
â””â”€â”€ search.py           # SemanticSearch
```

---

## ðŸ“‹ Componentes

### 1. EmbeddingsService

```python
# backend/apps/rag/services.py

import google.generativeai as genai
from chromadb import Client
from typing import List, Dict


class EmbeddingsService:
    """Generate and manage embeddings using Gemini."""
    
    def __init__(self):
        self.model = 'models/embedding-001'
        self.chroma = Client()
        
    def generate_embedding(self, text: str) -> List[float]:
        """Generate embedding for text using Gemini."""
        result = genai.embed_content(
            model=self.model,
            content=text,
            task_type="retrieval_document"
        )
        return result['embedding']
    
    def generate_query_embedding(self, query: str) -> List[float]:
        """Generate embedding for search query."""
        result = genai.embed_content(
            model=self.model,
            content=query,
            task_type="retrieval_query"
        )
        return result['embedding']
    
    def batch_embed(self, texts: List[str]) -> List[List[float]]:
        """Generate embeddings for multiple texts."""
        return [self.generate_embedding(t) for t in texts]
```

### 2. ActionSearchService

```python
class ActionSearchService:
    """Semantic search over actions library."""
    
    COLLECTION_NAME = 'actions_library'
    
    def __init__(self):
        self.embeddings = EmbeddingsService()
        self.collection = self.embeddings.chroma.get_or_create_collection(
            name=self.COLLECTION_NAME,
            metadata={"hnsw:space": "cosine"}
        )
    
    def index_action(self, action: Dict):
        """Index a single action."""
        text = f"{action['title']} {action['description']} {action.get('context', '')}"
        embedding = self.embeddings.generate_embedding(text)
        
        self.collection.add(
            ids=[action['id']],
            embeddings=[embedding],
            metadatas=[{
                'title': action['title'],
                'module': action.get('module'),
                'council': action.get('council'),
                'priority': action.get('priority'),
            }],
            documents=[text]
        )
    
    def search(
        self, 
        query: str, 
        n_results: int = 5,
        filters: Dict = None
    ) -> List[Dict]:
        """Search for relevant actions."""
        query_embedding = self.embeddings.generate_query_embedding(query)
        
        where = filters if filters else None
        
        results = self.collection.query(
            query_embeddings=[query_embedding],
            n_results=n_results,
            where=where,
            include=['metadatas', 'documents', 'distances']
        )
        
        return [
            {
                'id': results['ids'][0][i],
                'title': results['metadatas'][0][i]['title'],
                'module': results['metadatas'][0][i].get('module'),
                'council': results['metadatas'][0][i].get('council'),
                'relevance': 1 - results['distances'][0][i],  # Convert distance to similarity
                'text': results['documents'][0][i]
            }
            for i in range(len(results['ids'][0]))
        ]
```

### 3. PlaybookIndexer

```python
class PlaybookIndexer:
    """Index playbooks for semantic search."""
    
    COLLECTION_NAME = 'playbooks'
    
    def index_all_playbooks(self):
        """Index all playbooks from YAML files."""
        playbooks = PlaybookConfig.objects.all()
        
        for playbook in playbooks:
            text = f"""
            Module: {playbook.name}
            Question: {playbook.primary_question}
            Role: {playbook.strategic_role}
            Council: {playbook.owner_council}
            """
            
            self.index_playbook(playbook.module_id, text, {
                'name': playbook.name,
                'council': playbook.owner_council,
                'version': playbook.version
            })
    
    def find_similar_playbooks(self, context: str, n: int = 3) -> List[Dict]:
        """Find playbooks similar to given context."""
        return self.search(context, n_results=n)
```

---

## ðŸ“„ ChromaDB Collections

| Collection | Content | Use Case |
|------------|---------|----------|
| actions_library | Historical actions | Suggest similar actions |
| playbooks | Playbook summaries | Find relevant playbooks |
| insights | Historical insights | Pattern matching |
| recommendations | Past recommendations | Avoid repetition |

---

## ðŸ”§ API Endpoints

```python
# backend/apps/rag/views.py

class ActionSearchView(APIView):
    """Search actions library."""
    
    def post(self, request):
        query = request.data.get('query')
        filters = request.data.get('filters', {})
        n_results = request.data.get('n_results', 5)
        
        service = ActionSearchService()
        results = service.search(query, n_results, filters)
        
        return Response({'results': results})


class SimilarPlaybooksView(APIView):
    """Find similar playbooks."""
    
    def post(self, request):
        context = request.data.get('context')
        n = request.data.get('n', 3)
        
        indexer = PlaybookIndexer()
        results = indexer.find_similar_playbooks(context, n)
        
        return Response({'playbooks': results})
```

---

## âœ… Entregables

- [ ] EmbeddingsService class
- [ ] ActionSearchService class
- [ ] PlaybookIndexer class
- [ ] ChromaDB collections setup
- [ ] API endpoints
- [ ] Indexing management command
- [ ] Unit tests
- [ ] Integration tests
