# ‚è±Ô∏è Phase 8: Time Decay Plan

**Duraci√≥n:** 0.5 semanas  
**Prioridad:** P2 - Medio  
**Gap:** 100% - No implementado

---

## üéØ Objetivo

Implementar degradaci√≥n temporal de se√±ales para reflejar la frescura de los datos.

---

## üìä Problema

- Los datos no indican cu√°ndo fueron recolectados
- Confidence no degrada con el tiempo
- No hay alertas de datos stale
- Usuarios pueden tomar decisiones con datos obsoletos

---

## üèóÔ∏è Time Decay Service

```python
# backend/apps/core/time_decay.py

from datetime import datetime, timedelta
from typing import Dict, Optional


class TimeDecayService:
    """
    Calculates data freshness and applies time-based confidence decay.
    """
    
    # Decay rules by data source
    DECAY_RULES = {
        'google_trends': {
            'fresh': 7,      # days - 100% confidence
            'moderate': 30,  # days - 80% confidence
            'stale': 90,     # days - 50% confidence
            'expired': 180,  # days - 20% confidence
        },
        'ahrefs': {
            'fresh': 14,
            'moderate': 45,
            'stale': 90,
            'expired': 180,
        },
        'dataforseo': {
            'fresh': 7,
            'moderate': 30,
            'stale': 60,
            'expired': 120,
        },
        'brightdata': {
            'fresh': 3,
            'moderate': 14,
            'stale': 30,
            'expired': 60,
        },
        'serpapi': {
            'fresh': 1,
            'moderate': 7,
            'stale': 14,
            'expired': 30,
        },
    }
    
    def calculate_freshness(
        self, 
        data_timestamp: datetime, 
        source: str
    ) -> Dict:
        """
        Calculate data freshness score and status.
        
        Returns:
            {
                'age_days': int,
                'freshness_score': float (0-1),
                'status': 'fresh' | 'moderate' | 'stale' | 'expired',
                'decay_factor': float (0-1),
                'warning': Optional[str]
            }
        """
        age = datetime.now() - data_timestamp
        age_days = age.days
        
        rules = self.DECAY_RULES.get(source, self.DECAY_RULES['ahrefs'])
        
        if age_days <= rules['fresh']:
            status = 'fresh'
            decay_factor = 1.0
        elif age_days <= rules['moderate']:
            status = 'moderate'
            decay_factor = 0.8
        elif age_days <= rules['stale']:
            status = 'stale'
            decay_factor = 0.5
        else:
            status = 'expired'
            decay_factor = 0.2
        
        warning = None
        if status == 'stale':
            warning = f"Data is {age_days} days old. Consider refreshing."
        elif status == 'expired':
            warning = f"Data is {age_days} days old. Refresh required for reliable insights."
        
        return {
            'age_days': age_days,
            'freshness_score': decay_factor,
            'status': status,
            'decay_factor': decay_factor,
            'warning': warning
        }
    
    def apply_decay(
        self, 
        confidence: float, 
        data_timestamp: datetime, 
        source: str
    ) -> float:
        """Apply time decay to confidence score."""
        freshness = self.calculate_freshness(data_timestamp, source)
        return confidence * freshness['decay_factor']
    
    def get_composite_freshness(
        self, 
        data_sources: Dict[str, datetime]
    ) -> Dict:
        """
        Calculate composite freshness for multiple data sources.
        
        Args:
            data_sources: Dict mapping source name to timestamp
            
        Returns:
            Composite freshness with per-source breakdown
        """
        results = {}
        scores = []
        
        for source, timestamp in data_sources.items():
            freshness = self.calculate_freshness(timestamp, source)
            results[source] = freshness
            scores.append(freshness['freshness_score'])
        
        return {
            'composite_score': sum(scores) / len(scores) if scores else 0,
            'min_score': min(scores) if scores else 0,
            'sources': results,
            'any_stale': any(r['status'] in ['stale', 'expired'] for r in results.values()),
            'all_fresh': all(r['status'] == 'fresh' for r in results.values())
        }
```

---

## üìã Integration

### Module Output Enhancement

```python
# In module executors

def _execute_market_demand(self, brand, period_start, period_end, inputs):
    # ... existing logic ...
    
    # Add timestamp to output
    output['data_timestamp'] = datetime.now()
    output['data_sources_timestamps'] = {
        'google_trends': datetime.now(),
    }
    
    # Apply time decay to confidence
    time_decay = TimeDecayService()
    output['freshness'] = time_decay.get_composite_freshness(
        output['data_sources_timestamps']
    )
    output['confidence'] = time_decay.apply_decay(
        output['confidence'],
        output['data_timestamp'],
        'google_trends'
    )
    
    return output
```

### Frontend Indicator

```tsx
// frontend/src/components/modules/shared/FreshnessIndicator.tsx

interface FreshnessIndicatorProps {
  freshness: {
    age_days: number;
    status: 'fresh' | 'moderate' | 'stale' | 'expired';
    warning?: string;
  };
}

export const FreshnessIndicator: React.FC<FreshnessIndicatorProps> = ({
  freshness
}) => {
  const statusConfig = {
    fresh: { icon: 'üü¢', label: 'Fresh', color: 'text-green-600' },
    moderate: { icon: 'üü°', label: 'Recent', color: 'text-yellow-600' },
    stale: { icon: 'üü†', label: 'Stale', color: 'text-orange-600' },
    expired: { icon: 'üî¥', label: 'Expired', color: 'text-red-600' },
  };
  
  const config = statusConfig[freshness.status];
  
  return (
    <div className="flex items-center gap-2">
      <span>{config.icon}</span>
      <span className={`text-sm ${config.color}`}>
        {config.label} ({freshness.age_days}d ago)
      </span>
      {freshness.warning && (
        <Tooltip content={freshness.warning}>
          <span className="text-yellow-500">‚ö†Ô∏è</span>
        </Tooltip>
      )}
    </div>
  );
};
```

---

## ‚úÖ Entregables

- [ ] TimeDecayService class
- [ ] Decay rules por data source
- [ ] Integration con module executors
- [ ] FreshnessIndicator component
- [ ] Warnings para datos stale
- [ ] Unit tests
