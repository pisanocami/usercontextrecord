# User Context Record (UCR) Specification

> UCR Technical Specification
> 
> Version 3.2 - January 2026

---

## Overview

The User Context Record (UCR) is the **single source of truth** for all brand intelligence. No analytical module can execute without a validated and complete UCR.

**Fundamental principle:** Context-First, Decision-First

---

## Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         UCR: SINGLE SOURCE OF TRUTH                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────┐          │
│   │                    8 CANONICAL SECTIONS                      │          │
│   ├─────────────────────────────────────────────────────────────┤          │
│   │                                                              │          │
│   │  A. Brand Context      │  E. Strategic Intent               │          │
│   │  B. Category Definition│  F. Channel Context                │          │
│   │  C. Competitive Set    │  G. Negative Scope                 │          │
│   │  D. Demand Definition  │  H. Governance                     │          │
│   │                                                              │          │
│   └─────────────────────────────────────────────────────────────┘          │
│                              │                                              │
│                              ▼                                              │
│   ┌─────────────────────────────────────────────────────────────┐          │
│   │              EXECUTION GATEWAY                               │          │
│   │  ├── Validates UCR completeness                             │          │
│   │  ├── Checks required sections                               │          │
│   │  ├── Verifies UCR status (LOCKED required)                  │          │
│   │  └── Injects context into modules                           │          │
│   └─────────────────────────────────────────────────────────────┘          │
│                              │                                              │
│                              ▼                                              │
│   ┌─────────────────────────────────────────────────────────────┐          │
│   │              ANALYSIS MODULES                                │          │
│   │  ├── Keyword Gap Lite                                       │          │
│   │  ├── Category Demand Signal (planned)                       │          │
│   │  ├── Brand Attention (planned)                              │          │
│   │  └── Strategic Levers (planned)                             │          │
│   └─────────────────────────────────────────────────────────────┘          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## UCR Status Lifecycle

The UCR goes through a lifecycle with defined states:

```
DRAFT_AI → PENDING_REVIEW → APPROVED → LOCKED
    │           │              │          │
    │           ▼              ▼          ▼
    └──────► REJECTED ◄────────┘     (immutable)
```

| Status | Description | Module Execution |
|--------|-------------|------------------|
| DRAFT_AI | Generated by AI, no review | Blocked |
| PENDING_REVIEW | Under human review | Blocked |
| APPROVED | Approved, can be edited | Allowed with warnings |
| LOCKED | Locked, immutable | Full access |
| REJECTED | Rejected, requires regeneration | Blocked |

---

## Section A: Brand Context

Defines the fundamental identity of the brand.

### Schema

```typescript
interface BrandContext {
  name: string;             // Brand name
  domain: string;           // Primary domain (required)
  tagline?: string;         // Value proposition
  industry?: string;        // Industry (auto-detected)
  revenue_band?: string;    // Revenue range
  target_market?: string;   // Target market
  business_model?: 'B2B' | 'B2C' | 'Hybrid';
  primary_geography?: string[];
}
```

### Validation Rules

- `domain` is required and must be a valid domain
- `name` is automatically generated from domain if not provided

### Usage in Modules

```typescript
// Keyword Gap: starting point of analysis
const clientDomain = config.brand.domain; // "oofos.com"
```

---

## Section B: Category Definition

Defines the "fence" of relevant categories for the brand.

### Schema

```typescript
interface CategoryDefinition {
  primary_category: string;       // Primary category
  approved_categories?: string[]; // Approved categories
  included_categories?: string[]; // Alias: included categories
  excluded_categories?: string[]; // Categories to ignore
  alternative_categories?: string[];
}
```

### Fence Logic

```typescript
function checkFence(keyword: string, config: Configuration): FenceResult {
  const included = config.category_definition?.approved_categories || [];
  const excluded = config.category_definition?.excluded_categories || [];
  
  // Exclusion takes priority
  if (excluded.some(cat => keyword.includes(cat.toLowerCase()))) {
    return { inFence: false, reason: "Excluded category" };
  }
  
  // Explicit inclusion
  if (included.some(cat => keyword.includes(cat.toLowerCase()))) {
    return { inFence: true, reason: "Included category" };
  }
  
  return { inFence: false, reason: "No category match" };
}
```

---

## Section C: Competitive Set

Defines the set of competitors for analysis.

### Schema

```typescript
interface CompetitiveSet {
  competitors: Competitor[];
  direct?: string[];      // Legacy: direct competitor names
  indirect?: string[];    // Legacy: indirect competitor names
  marketplaces?: string[];
  approved_count: number;
  rejected_count: number;
  pending_review_count: number;
}

interface Competitor {
  name: string;
  domain: string;
  tier: 'tier1' | 'tier2' | 'tier3';
  status: 'approved' | 'rejected' | 'pending';
  added_by: 'ai' | 'human';
  added_at: string;
  evidence?: CompetitorEvidence;
}
```

### Tier Definitions

| Tier | Description | Gap Analysis |
|------|-------------|--------------|
| tier1 | Direct competitors | Included |
| tier2 | Indirect competitors | Included |
| tier3 | Aspirational players | Excluded |

---

## Section D: Demand Definition

Defines demand clusters and seed keywords.

### Schema

```typescript
interface DemandDefinition {
  brand_keywords: {
    seed_terms: string[];
    top_n: number;
  };
  non_brand_keywords: {
    category_terms: string[];
    problem_terms: string[];
    top_n: number;
  };
}
```

### Usage

- `brand_keywords.seed_terms`: brand terms for filtering
- `non_brand_keywords`: base for keyword expansion

---

## Section E: Strategic Intent

Defines goals and strategic horizon.

### Schema

```typescript
interface StrategicIntent {
  primary_goal: string;
  secondary_goals?: string[];
  goal_type: 'awareness' | 'consideration' | 'conversion' | 'roi';
  time_horizon: 'short' | 'medium' | 'long';
  risk_tolerance: 'low' | 'medium' | 'high';
  growth_priority?: string;
  avoid?: string[];
  constraint_flags: {
    budget_constrained: boolean;
    resource_limited: boolean;
    regulatory_sensitive: boolean;
    brand_protection_priority: boolean;
  };
}
```

---

## Section F: Channel Context

Defines marketing channel context.

### Schema

```typescript
interface ChannelContext {
  seo_investment_level: 'none' | 'low' | 'medium' | 'high';
  paid_media_active: boolean;
  marketplace_dependence: 'none' | 'low' | 'medium' | 'high';
}
```

---

## Section G: Negative Scope

Defines absolute exclusions for brand protection.

### Schema

```typescript
interface NegativeScope {
  excluded_keywords: string[];
  excluded_categories: string[];
  excluded_use_cases: string[];
  excluded_competitors: string[];
  
  keyword_exclusions: ExclusionRule[];
  category_exclusions: ExclusionRule[];
  use_case_exclusions: ExclusionRule[];
  competitor_exclusions: ExclusionRule[];
  
  enforcement_rules: {
    hard_exclusion: boolean;
    allow_model_suggestion: boolean;
    require_human_override_for_expansion: boolean;
  };
  
  audit_log: AuditEntry[];
}

interface ExclusionRule {
  value: string;
  reason: string;
  added_by: 'ai' | 'human';
  added_at: string;
  match_type: 'exact' | 'contains' | 'regex';
  semantic_sensitivity: 'low' | 'medium' | 'high';
}
```

### Gate Behavior

Section G acts as a **hard gate**:
- Keywords matching exclusions → immediate OUT_OF_PLAY
- No override possible without UCR change

---

## Section H: Governance

Governance metadata and audit.

### Schema

```typescript
interface Governance {
  context_version: number;
  context_status: 'DRAFT_AI' | 'PENDING_REVIEW' | 'APPROVED' | 'LOCKED';
  context_hash: string;
  context_valid_until: string;
  context_confidence: {
    level: 'low' | 'medium' | 'high';
    notes: string;
  };
  
  quality_score: QualityScore;
  validation_status: 'incomplete' | 'needs_review' | 'complete' | 'blocked';
  blocked_reasons: string[];
  
  human_verified: boolean;
  reviewed_by: string;
  last_reviewed: string;
  
  cmo_safe: boolean;
  model_suggested: boolean;
  
  ai_behavior: AIBehavior;
  human_overrides: HumanOverrides;
  section_approvals: Record<string, SectionApproval>;
}

interface QualityScore {
  overall: number;           // 0-100
  grade: 'low' | 'medium' | 'high';
  completeness: number;
  evidence_coverage: number;
  competitor_confidence: number;
  negative_strength: number;
  calculated_at: string;
  breakdown: {
    completeness_details: string;
    evidence_details: string;
    competitor_details: string;
    negative_details: string;
  };
}
```

---

## Validation Requirements

### Section Completeness

| Section | Required Fields | Minimum for Module Execution |
|---------|-----------------|------------------------------|
| A | domain | Yes |
| B | primary_category | Yes (for fence checking) |
| C | competitors[] (1+) | Yes (for gap analysis) |
| D | - | Optional |
| E | - | Optional |
| F | - | Optional |
| G | enforcement_rules | Yes (for hard gates) |
| H | context_version | Yes |

### Module Requirements

| Module | Required Sections | Optional Sections |
|--------|-------------------|-------------------|
| seo_visibility_gap | A, B, C | D, E, F, G, H |
| category_demand_signal | A, B | D, E, G, H |
| brand_attention | A, B, C | E, H |

---

## API Endpoints

### Get UCR

```
GET /api/configurations/:id
```

Returns full UCR with all 8 sections.

### Update Section

```
PATCH /api/configurations/:id
Body: { section_name: { ...fields } }
```

### Validate UCR

```
POST /api/configurations/:id/validate
```

Returns validation result with section-by-section status.

### Lock UCR

```
POST /api/configurations/:id/lock
```

Transitions UCR to LOCKED status (immutable).

---

## Database Schema

```typescript
// shared/schema.ts
export const configurations = pgTable("configurations", {
  id: serial("id").primaryKey(),
  userId: text("user_id"),
  name: text("name").notNull(),
  brand: jsonb("brand"),
  category_definition: jsonb("category_definition"),
  competitors: jsonb("competitors"),
  demand_definition: jsonb("demand_definition"),
  strategic_intent: jsonb("strategic_intent"),
  channel_context: jsonb("channel_context"),
  negative_scope: jsonb("negative_scope"),
  governance: jsonb("governance"),
  created_at: timestamp("created_at").defaultNow(),
  updated_at: timestamp("updated_at").defaultNow(),
});
```

---

## Best Practices

1. **Complete UCR before module execution** - Ensures reliable results
2. **Lock UCR for production use** - Prevents mid-analysis changes
3. **Review AI suggestions** - Never auto-approve without review
4. **Document human overrides** - Maintain audit trail
5. **Set context expiration** - UCRs should be reviewed periodically
